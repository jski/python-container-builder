name: Check Python Versions

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  workflow_dispatch:

jobs:
  check-versions:
    name: Check for Python version updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check current Python versions
        id: check
        run: |
          echo "Checking Python versions from official images..."

          # Initialize arrays
          declare -A current_versions
          declare -A new_versions

          # Current minor versions we support
          MINOR_VERSIONS=("3.9" "3.10" "3.11" "3.12" "3.13" "3.14")

          # Check each version
          for minor in "${MINOR_VERSIONS[@]}"; do
            # Determine debian version
            if [[ "$minor" == "3.9" || "$minor" == "3.10" ]]; then
              debian="bullseye"
            else
              debian="bookworm"
            fi

            echo "Checking Python ${minor} (${debian})..."

            # Get actual version from official image
            version=$(docker run --rm python:${minor}-slim-${debian} python --version 2>&1 | grep -oP 'Python \K[\d.]+' || echo "")

            if [ -n "$version" ]; then
              current_versions[$minor]=$version
              echo "  Found: $version"
            else
              echo "  ERROR: Could not detect version for ${minor}"
              current_versions[$minor]="unknown"
            fi
          done

          # Check for Python 3.15 (future version)
          echo "Checking for Python 3.15..."
          if docker pull python:3.15-slim-bookworm 2>/dev/null; then
            version=$(docker run --rm python:3.15-slim-bookworm python --version 2>&1 | grep -oP 'Python \K[\d.]+' || echo "")
            if [ -n "$version" ]; then
              echo "  NEW VERSION FOUND: Python 3.15 ($version)"
              current_versions["3.15"]=$version
              echo "new_minor_version=3.15" >> $GITHUB_OUTPUT
            fi
          else
            echo "  Python 3.15 not yet available"
          fi

          # Save versions to file for next step
          for minor in "${!current_versions[@]}"; do
            echo "${minor}=${current_versions[$minor]}" >> /tmp/versions.txt
          done

          # Output for debugging
          cat /tmp/versions.txt

      - name: Update README with versions
        id: update-readme
        run: |
          echo "Updating README with current versions..."

          # Read versions
          declare -A versions
          while IFS='=' read -r minor version; do
            versions[$minor]=$version
          done < /tmp/versions.txt

          # Create backup
          cp README.md README.md.backup

          # Update the table in README
          # This updates the "Python Source" column with actual versions
          for minor in "${!versions[@]}"; do
            version="${versions[$minor]}"
            if [[ "$minor" == "3.9" || "$minor" == "3.10" ]]; then
              debian="bullseye"
            else
              debian="bookworm"
            fi

            # Update the line in the table
            sed -i "s/| ${minor} | \`:${minor}\` | \`python:${minor}-slim-${debian}\` |/| ${minor} | \`:${minor}\` | \`python:${minor}-slim-${debian}\` (${version}) |/g" README.md
          done

          # Check if there were changes
          if ! diff -q README.md README.md.backup > /dev/null 2>&1; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "Changes detected in README"

            # Show diff
            echo "Diff:"
            diff README.md.backup README.md || true
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

          rm README.md.backup

      - name: Update workflow matrix if new minor version found
        if: steps.check.outputs.new_minor_version
        run: |
          NEW_VERSION="${{ steps.check.outputs.new_minor_version }}"
          echo "Adding Python ${NEW_VERSION} to workflow matrix..."

          # Read the version from temp file
          VERSION=$(grep "^${NEW_VERSION}=" /tmp/versions.txt | cut -d= -f2)

          # Add to build.yml matrix
          WORKFLOW_FILE=".github/workflows/build.yml"

          # Insert new version in matrix (before the last item)
          # Find the line with "3.14" and add the new version after it
          sed -i "/python_version: \"3.14\"/a\\          - python_version: \"${NEW_VERSION}\"\n            debian_version: \"bookworm\"" $WORKFLOW_FILE

          # Update the test matrix
          sed -i "s/python_version: \[\"3.9\", \"3.10\", \"3.11\", \"3.12\", \"3.13\", \"3.14\"\]/python_version: [\"3.9\", \"3.10\", \"3.11\", \"3.12\", \"3.13\", \"3.14\", \"${NEW_VERSION}\"]/" $WORKFLOW_FILE

          # Update latest tag logic (3.14 -> new version)
          sed -i "s/matrix.python_version == '3.14'/matrix.python_version == '${NEW_VERSION}'/" $WORKFLOW_FILE

          echo "Workflow updated to include Python ${NEW_VERSION}"

      - name: Create Pull Request
        if: steps.update-readme.outputs.changes_detected == 'true' || steps.check.outputs.new_minor_version
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: Update Python versions

            - Updated README with current Python versions
            ${{ steps.check.outputs.new_minor_version && format('- Added Python {0} to build matrix', steps.check.outputs.new_minor_version) || '' }}
          branch: update-python-versions
          delete-branch: true
          title: 'chore: Update Python versions'
          body: |
            ## Python Version Update

            This PR updates the Python version information:

            ### Changes
            - âœ… Updated README with current Python versions from official images
            ${{ steps.check.outputs.new_minor_version && format('- âœ… **NEW**: Added Python {0} to build matrix', steps.check.outputs.new_minor_version) || '' }}

            ### Version Details
            ```
            $(cat /tmp/versions.txt)
            ```

            ### What happens next?
            1. Review the changes
            2. Merge this PR to trigger a new build with updated versions
            3. Images will be built and pushed automatically

            ---
            ðŸ¤– Auto-generated by weekly version check workflow
          labels: dependencies,automated
